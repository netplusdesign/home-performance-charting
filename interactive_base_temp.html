<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />

		<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
		Remove this if you use the .htaccess -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

		<title>Base Temperature Charting</title>
		<meta name="description" content="" />
		<meta name="author" content="Larry Burks" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="style/screen.css" media="screen">
	</head>

	<body>
		<div id="page">
			<header>
				<h1><a href="http://uphillhouse.wordpress.com">Up Hill House</a></h1>
			</header>
			<div id="calendar">
				<nav>
					<select id="slice">
						<option selected="selected" value='2012'>2012</option>
					</select>
				<select id="dice">
					<optgroup label="Monthly">
						<option value="monthly_summary.php">Summary</option>
						<option value="monthly_generation.php">Generation</option>
						<option value="monthly_usage.php">Usage</option>
						<option value="monthly_hdd.php">Heating Degree Days</option>
						<option selected="selected" value="interactive_base_temp.html">Base Temp Analysis</option>
					</optgroup>
					<optgroup label="Daily">
						<option id="adjusted" value="daily.html?option=1">Net Usage</option>
						<option id="solar" value="daily.html?option=2">Generation</option>
						<option id="usage" value="daily.html?option=3">Usage</option>
						<optgroup label="Daily Usage by Circuit">
							<option id="usage-ashp" value="daily.html?option=8">ASHP</option>
							<option id="usage-dwh" value="daily.html?option=7">Water Heater</option>
							<option id="usage-range" value="daily.html?option=13">Range</option>
							<option id="usage-dryer" value="daily.html?option=10">Dryer</option>
							<option id="usage-dw" value="daily.html?option=12">Dish Washer</option>
							<option id="usage-wp" value="daily.html?option=9">Water Pump</option>
							<option id="usage-washer" value="daily.html?option=11">Washer</option>
						</optgroup>
						<optgroup label="Daily Temperature">
							<option id="hdd" value="daily.html?option=6">Heating Degree Days</option>
							<option id="temp-low" value="daily.html?option=4">Outdoor Temperature (Low)</option>
							<option id="temp-high" value="daily.html?option=9">Outdoor Temperature (High)</option>
						</optgroup>
					</optgroup>
				</select>
				</nav>
				<p>Sample detail:</p>
				<ul>
					<li><input type="radio" id="hours" name="period" checked="checked" value="hours" /><label for="hours">Hours</label></li>
					<li><input type="radio" id="days" name="period" value="days" /><label for="days">Days</label></li>
					<li><input type="radio" id="months" name="period" value="months" /><label for="months">Months</label></li>
				</ul>
				<p>Base temperature: (Ex. 65)</p>
				<ul>
					<li><input type="text" id="base" value="65.0" pattern="[0-9]*" /></li>
				</ul>
				<p><input type="button" id="update" value="Update" /></p>
				<p>Regression Line:</p>
				<ul>
					<li>Slope : <span id="slope">Calculating...</span></li>
					<li>Intercept : <span id="intercept">Calculating...</span></li>
					<li>R<sup>2</sup> : <span id="r2">Calculating...</span></li>
					<li>y = <span id="slope">slope</span>x <span id="plus"></span></span><span id="intercept">intercept</span></li>
				</ul>
				<p id="reporting"></p>â€‹
			</div>
			<div id="chart"></div>
			
			<footer>
				<p>
					&copy; Copyright  by Larry Burks
				</p>
			</footer>
		</div>
		<script src="js/jquery-1.7.1.min.js"></script>
		<script src="js/highcharts.js" type="text/javascript"></script>
		<script>
		$(document).ready(function() 
		{
			(function(doc) 
			{
    			var addEvent = 'addEventListener',
       			type = 'gesturestart',
        		qsa = 'querySelectorAll',
        		scales = [1, 1],
        		meta = qsa in doc ? doc[qsa]('meta[name=viewport]') : [];
    			function fix() 
    			{
    			    meta.content = 'width=device-width,minimum-scale=' + scales[0] + ',maximum-scale=' + scales[1];
      			    doc.removeEventListener(type, fix, true);
    			}
			    if ((meta = meta[meta.length - 1]) && addEvent in doc) 
			    {
			        fix();
			        scales = [.25, 1.6];
			        doc[addEvent](type, fix, true);
			    }
			}(document));
			
   			var chart = null;
   			var options;
			var series = [];
			var xr = [];
			var yr = [];
			var currentOption = 'hours';
			var previousOption = 'hours';
			plot();
			
			$("select#dice").change(function(event)
       		{
       			window.location.assign( this.value + '?year=' + $("select#slice").val() ); 
     		});
     		
			// add handler to update button
			$("input#update").click(function(event){
				previousOption = currentOption;
				plot();
   				event.preventDefault();
   			});
   			
   			$('input:radio').change( function() {
   				currentOption = $('input:radio[name=period]:checked').val();
   			})
		
			function plot()
			{
				if (chart) chart.showLoading('Loading data...');
				var base = $('input#base').val();
				var period = $('input:radio[name=period]:checked').val();
				var dfile = "get_hdd_ashp.php?base=" + base + "&period=" + period;
				series = [];
				xr = [];
				yr = [];
				$.get(dfile, function(data) 
				{ 
					options = {
						chart : {
							renderTo : 'chart',
							zoomType: 'x'
						},
						credits: {
            				enabled: false
       					},
       						legend: {
            					borderWidth: 0
        				},
						title : {
							text : 'Correlating HDD with Heating energy'
						},
						xAxis : {
							title : {
								text : 'HDD'
							}
						},
						yAxis : {
							title : {
								text : 'kWh'
							}
						},
        				plotOptions: {
        					series: {
                				point: {
                    				events: {
                        				mouseOver: function() {
                            				$('p#reporting').html('HDD: '+ Math.round(this.x*1000)/1000 +'<br />kWh: '+ this.y + '<br />Date: ' + this['config'][2]);
                        				},
                        				click: function() {
                        					dt = this['config'][2].split(' ');
                        					tm = (previousOption == 'hours') ? '&time=' + dt[1].split(':')[0] : ''; 
                            				location.href = 'daily.html?option=8&date=' + dt[0] + tm;
                        				}
                    				}
                				},
                				events: {
                    				mouseOut: function() {                        
                        				$('p#reporting').empty();
                    				}
                				}
            				},
              				scatter: {
                    			marker: {
                        			radius: 5
                    			},
                    			states: {
                        			hover: {
                            			lineWidth: 0,
                            			marker: {
                                			enabled: false
                            			}
                        			}
                    			}
                			},
                			line: {
                				lineWidth: 2
                			}
            			},
						series : []
					}; // end set options
					
					var lines = data.split('\n');  // splits the file into lines
					series[0] = new Object();
					series[0].name = 'Data point';
					series[0].type = 'scatter';
					series[0].color = 'rgba(223, 83, 83, .5)';
					series[0].data = [];
					
					$.each(lines, function(lineNo, line) 
					{ 
						var items = line.split(','); // splits the line into items
						if (line == '') return false;
						// hdd, ashp
						xr[lineNo] = parseFloat(items[0]);
						yr[lineNo] = parseFloat(items[1]);
						series[0].data.push( Array( parseFloat(items[0]), parseInt(items[1]), items[2] ) );
						//series[0].data[series[0].data.length-1] = new Object();
						series[0].data[series[0].data.length-1].name = items[2];
					});
					
					var lr = linearRegression(yr,xr);
					$('span#slope').text(Math.round(lr.slope*10000)/10000);
					$('span#intercept').text(Math.round(lr.intercept*10000)/10000);
					$('span#r2').text(Math.round(lr.r2*10000)/10000);
					lr.intercept > 0 ? $('span#plus').text(' + ') : $('span#plus').text('');  
					
					series[1] = new Object();
					series[1].name = 'Regression Line';
					series[1].type = 'line';
					series[1].color = '#336699';
					series[1].data = [];
					
					start_x = Math.min.apply(Math, xr);
					start_y = lr.slope * start_x + lr.intercept;
					end_x = Math.max.apply(Math, xr);
					end_y = lr.slope * end_x + lr.intercept;
					
					series[1].data.push( Array(start_x, start_y) );
					series[1].data.push( Array(end_x, end_y) );
					
					options.series.push(series[0]);
					options.series.push(series[1]);
					
					if (chart == null) 
    				{
						chart = new Highcharts.Chart(options);
					}
					else
					{
						chart.series[0].setData(series[0].data);
						chart.series[1].setData(series[1].data);
					}
					chart.hideLoading();

				}); // end get
				
			} // end function plot_init();
		
			// Linear Regression calculation by Trent Richardson
			// http://trentrichardson.com/2010/04/06/compute-linear-regressions-in-javascript/
			// example input & output
			//var known_y = [1, 2, 3, 4];
			//var known_x = [5.2, 5.7, 5.0, 4.2];

			//var lr = linearRregression(known_y, known_x);
			// now you have:
			// lr.slope
			// lr.intercept
			// lr.r2
		
			function linearRegression(y,x)
			{
        		var lr = {};
        		var n = y.length;
        		var sum_x = 0;
        		var sum_y = 0;
        		var sum_xy = 0;
        		var sum_xx = 0;
        		var sum_yy = 0;
        		
        		for (var i = 0; i < y.length; i++) 
        		{     
            		sum_x += x[i];
            		sum_y += y[i];
            		sum_xy += (x[i]*y[i]);
            		sum_xx += (x[i]*x[i]);
            		sum_yy += (y[i]*y[i]);
        		} 
        		
        		lr['slope'] = (n * sum_xy - sum_x * sum_y) / (n*sum_xx - sum_x * sum_x);
        		lr['intercept'] = (sum_y - lr.slope * sum_x)/n;
        		lr['r2'] = Math.pow((n*sum_xy - sum_x*sum_y)/Math.sqrt((n*sum_xx-sum_x*sum_x)*(n*sum_yy-sum_y*sum_y)),2);
        
        		return lr;
			}
		}); // 
		</script>
	</body>
</html>
